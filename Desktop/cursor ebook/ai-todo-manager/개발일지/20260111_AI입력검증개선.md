# AI API 입력 검증 및 오류 처리 개선

**작성시각**: 2026-01-11 19:30

## 해결하고자 한 문제

AI 할 일 생성 API의 안정성과 사용자 경험 개선을 위해 입력 검증, 전처리, 후처리, 오류 응답 기능 추가

## 해결된 것

### 1. 입력 검증 (`validateInput`)

✅ **빈 문자열 체크**
```typescript
if (!input || input.trim().length === 0) {
  return { valid: false, error: '할 일 내용을 입력해줘' };
}
```

✅ **최소 길이 제한 (2자)**
```typescript
if (input.trim().length < 2) {
  return { valid: false, error: '최소 2자 이상 입력해줘' };
}
```

✅ **최대 길이 제한 (500자)**
```typescript
if (input.length > 500) {
  return { valid: false, error: '최대 500자까지 입력 가능해 (현재: ' + input.length + '자)' };
}
```

### 2. 전처리 (`preprocessInput`)

✅ **앞뒤 공백 제거**
```typescript
let processed = input.trim();
```

✅ **연속된 공백 통합**
```typescript
processed = processed.replace(/\s+/g, ' ');
```

**예시**:
- 입력: `"  여러   공백   테스트  "`
- 출력: `"여러 공백 테스트"`

### 3. 후처리 (`postprocessTodo`)

✅ **과거 날짜 자동 조정**
```typescript
if (dueDate < currentTime) {
  // 과거 날짜면 내일 09:00으로 설정
  const tomorrow = new Date(currentTime);
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(9, 0, 0, 0);
  result.due_date = tomorrow.toISOString().slice(0, 19) + '+09:00';
}
```

✅ **제목 길이 자동 조절**
```typescript
if (result.title.length > 50) {
  result.title = result.title.slice(0, 47) + '...';
}
if (result.title.length < 2) {
  result.title = '새 할 일';
}
```

✅ **필수 필드 기본값 설정**
- `title` 누락 → "새 할 일"
- `priority` 누락 → "medium"
- `category` 누락 → ["기타"]
- `due_date` 누락 → 우선순위에 따라 설정
  - high → 내일
  - medium → 3일 후
  - low → 7일 후

### 4. 오류 응답 개선

✅ **400: 잘못된 입력**
```typescript
return NextResponse.json(
  { error: validation.error },
  { status: 400 }
);
```

✅ **500: AI 처리 실패**
```typescript
return NextResponse.json(
  { error: 'AI 처리 중 오류가 발생했어. 잠시 후 다시 시도해줘.' },
  { status: 500 }
);
```

✅ **429: API 호출 한도 초과**
```typescript
if (error.message.includes('quota') || error.message.includes('rate limit')) {
  return NextResponse.json(
    { error: 'API 호출 한도를 초과했어. 잠시 후 다시 시도해줘.' },
    { status: 429 }
  );
}
```

## 해결되지 않은 것

없음 - 모든 기능이 정상 작동함

## 테스트 결과

### 입력 검증 테스트
- ✅ 빈 문자열 → 400 오류
- ✅ "a" (1자) → 400 오류
- ✅ 500자 초과 → 400 오류
- ✅ 정상 입력 → 성공

### 전처리 테스트
- ✅ "  여러   공백   테스트  " → "여러 공백 테스트"

### 후처리 테스트
- ✅ 과거 날짜 → 내일로 자동 조정
- ✅ 제목 50자 초과 → 자동 축약
- ✅ 필수 필드 누락 → 기본값 설정

## 향후 개발을 위한 컨텍스트 정리

### API 흐름

1. **요청 본문 파싱** → `input` 추출
2. **입력 검증** → `validateInput(input)`
3. **전처리** → `preprocessInput(input)`
4. **AI 생성** → `generateObject(...)`
5. **후처리** → `postprocessTodo(object)`
6. **응답 반환** → `NextResponse.json(finalTodo)`

### 검증 규칙

- 최소 길이: 2자
- 최대 길이: 500자
- 빈 문자열: 불허

### 기본값 설정 규칙

- 제목: "새 할 일"
- 우선순위: "medium"
- 카테고리: ["기타"]
- 마감일: 우선순위에 따라 1일/3일/7일 후

### 오류 코드

- 400: 잘못된 입력
- 429: API 호출 한도 초과
- 500: AI 처리 실패
