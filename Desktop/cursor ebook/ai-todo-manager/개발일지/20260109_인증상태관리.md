# Supabase 인증 상태 관리 기능 추가

**작성시각**: 2026-01-09 15:02

## 해결하고자 한 문제

Supabase 인증 상태를 관리하여 비로그인 사용자와 로그인된 사용자를 적절히 리다이렉트하고, 상태 변화를 실시간으로 반영

### 요구사항
1. 비로그인 사용자가 메인페이지 접근 시 로그인 페이지로 리다이렉트
2. 로그인된 사용자가 로그인/회원가입 페이지 접근 시 메인 페이지로 리다이렉트
3. 사용자 정보 표시
4. 로그아웃 시 세션 즉시 해제
5. 상태 변화 실시간 반영

## 해결된 것

### 메인 페이지 (app/page.tsx)

✅ **세션 확인 및 리다이렉트**
- `useEffect`로 페이지 로드 시 세션 확인
- 비로그인 사용자 `/login`으로 자동 리다이렉트
- 로딩 상태 처리

✅ **실시간 상태 변화 감지**
```typescript
const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
  if (session?.user) {
    setUser(session.user);
  } else {
    router.push("/login");
  }
});
```

✅ **사용자 정보 표시**
- 실제 로그인한 사용자 이메일 표시
- 아바타에 이메일 첫 글자 표시

✅ **로그아웃 기능**
- `supabase.auth.signOut()` 호출
- 세션 제거 및 로그인 페이지로 리다이렉트

### 로그인 페이지 (app/login/page.tsx)

✅ **이미 로그인된 사용자 체크**
```typescript
useEffect(() => {
  const checkSession = async () => {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session?.user) {
      router.push("/");
      router.refresh();
    }
  };
  
  checkSession();
}, [router]);
```

✅ **로딩 상태 처리**
- `isChecking` 상태로 세션 확인 중 표시
- 로딩 화면 일관성 유지

### 회원가입 페이지 (app/signup/page.tsx)

✅ **이미 로그인된 사용자 체크**
- 로그인 페이지와 동일한 로직
- 이미 로그인된 경우 메인 페이지로 리다이렉트

✅ **로딩 상태 처리**
- 세션 확인 중 로딩 화면 표시

## 해결되지 않은 것

없음

## 향후 개발을 위한 컨텍스트 정리

### 인증 흐름 다이어그램

```
비로그인 사용자:
1. / 접근
2. 세션 확인 (없음)
3. /login으로 리다이렉트
4. 로그인 성공
5. /로 이동

로그인된 사용자:
1. /login 또는 /signup 접근
2. 세션 확인 (있음)
3. /로 리다이렉트
4. 사용자 정보 표시
```

### 실시간 상태 동기화

**onAuthStateChange 이벤트**:
- `SIGNED_IN`: 로그인 성공
- `SIGNED_OUT`: 로그아웃
- `TOKEN_REFRESHED`: 토큰 갱신
- `USER_UPDATED`: 사용자 정보 업데이트

**다중 탭 동기화**:
- 한 탭에서 로그인하면 다른 탭도 자동으로 업데이트
- 한 탭에서 로그아웃하면 다른 탭도 자동으로 로그아웃

### 보안 고려사항

1. **클라이언트 사이드 체크만으로는 부족**
   - 현재는 클라이언트에서만 세션 확인
   - 향후 서버 사이드에서도 체크 필요 (미들웨어)

2. **토큰 갱신**
   - Supabase가 자동으로 토큰 갱신
   - `onAuthStateChange`가 이를 감지

3. **세션 유효성**
   - 세션은 1시간 유효
   - 리프레시 토큰으로 자동 갱신

### 테스트 시나리오

**시나리오 1: 비로그인 사용자**
1. 브라우저 열기
2. `localhost:3000` 접속
3. 자동으로 `/login`으로 리다이렉트 확인

**시나리오 2: 로그인된 사용자**
1. 로그인 성공
2. 주소창에 `localhost:3000/login` 입력
3. 자동으로 `/`로 리다이렉트 확인

**시나리오 3: 실시간 동기화**
1. 탭 A에서 로그인
2. 탭 B 열기
3. 탭 B에서도 로그인 상태 확인

**시나리오 4: 로그아웃**
1. 로그아웃 버튼 클릭
2. 즉시 `/login`으로 이동 확인
3. 다른 탭들도 자동으로 로그아웃 확인

### 다음 단계

1. **미들웨어 추가**
   - `middleware.ts`에서 서버 사이드 라우트 보호
   - API 라우트 보호

2. **사용자 프로필 페이지**
   - 프로필 정보 수정
   - 비밀번호 변경

3. **Todo 데이터 Supabase 연동**
   - 현재 Mock 데이터를 실제 Supabase 데이터로 변경
   - CRUD 작업 구현

4. **에러 처리 개선**
   - 네트워크 오류 처리
   - 세션 만료 처리
