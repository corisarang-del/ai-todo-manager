# 프롬프트: AI API 입력 검증 및 오류 처리 개선

**작성시각**: 2026-01-11 19:30

## 사용자 요청

```
AI 할 일 생성 API에 입력 검증 기능을 추가해 주세요.

1. 입력 검증
 - 빈 문자열 체크
 - 최대 길이 제한 (500자)
 - 최소 길이 제한(2자)
 - 특수 문자나 이모지 처리

2. 전처리
 - 앞뒤 공백 제거
 - 연속된 공백을 하나로 통합
 - 대소문자 정규화

3. 후처리
 - 생성된 날짜가 과거인지 확인
 - 제목이 너무 길거나 짧은 경우 자동 조절
 - 필수 필드 누락 시 기본값 설정

4. 오류 응답
 - 400: 잘못된 입력
 - 500: AI 처리 실패
 - 429: API 호출 한도 초과
 - 각 상황에 맞는 사용자 친화적 오류 메세지
```

## 구현 내용

### 1. 입력 검증 함수 (`validateInput`)

```typescript
function validateInput(input: string): { valid: boolean; error?: string } {
  // 빈 문자열 체크
  if (!input || input.trim().length === 0) {
    return { valid: false, error: '할 일 내용을 입력해줘' };
  }
  
  // 최소 길이 제한 (2자)
  if (input.trim().length < 2) {
    return { valid: false, error: '최소 2자 이상 입력해줘' };
  }
  
  // 최대 길이 제한 (500자)
  if (input.length > 500) {
    return { valid: false, error: '최대 500자까지 입력 가능해 (현재: ' + input.length + '자)' };
  }
  
  return { valid: true };
}
```

### 2. 전처리 함수 (`preprocessInput`)

```typescript
function preprocessInput(input: string): string {
  // 앞뒤 공백 제거
  let processed = input.trim();
  
  // 연속된 공백을 하나로 통합
  processed = processed.replace(/\s+/g, ' ');
  
  return processed;
}
```

### 3. 후처리 함수 (`postprocessTodo`)

```typescript
function postprocessTodo(todo: any, currentTime: Date): any {
  // 1. 과거 날짜 확인 및 조정
  if (todo.due_date) {
    const dueDate = new Date(todo.due_date);
    if (dueDate < currentTime) {
      // 내일 09:00으로 설정
      const tomorrow = new Date(currentTime);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(9, 0, 0, 0);
      todo.due_date = tomorrow.toISOString().slice(0, 19) + '+09:00';
    }
  }
  
  // 2. 제목 길이 조절
  if (todo.title && todo.title.length > 50) {
    todo.title = todo.title.slice(0, 47) + '...';
  }
  
  // 3. 필수 필드 기본값
  if (!todo.title) todo.title = '새 할 일';
  if (!todo.priority) todo.priority = 'medium';
  if (!todo.category || todo.category.length === 0) {
    todo.category = ['기타'];
  }
  
  return todo;
}
```

### 4. 오류 응답 개선

```typescript
// 400: 잘못된 입력
if (!validation.valid) {
  return NextResponse.json(
    { error: validation.error },
    { status: 400 }
  );
}

// 429: API 호출 한도 초과
if (error.message.includes('quota') || error.message.includes('rate limit')) {
  return NextResponse.json(
    { error: 'API 호출 한도를 초과했어. 잠시 후 다시 시도해줘.' },
    { status: 429 }
  );
}

// 500: AI 처리 실패
return NextResponse.json(
  { error: 'AI 처리 중 오류가 발생했어. 잠시 후 다시 시도해줘.' },
  { status: 500 }
);
```

## 검증 방법

### 1. 입력 검증 테스트
- 빈 문자열 → 400 오류 "할 일 내용을 입력해줘"
- "a" → 400 오류 "최소 2자 이상 입력해줘"
- 500자 초과 → 400 오류 "최대 500자까지 입력 가능해"

### 2. 전처리 테스트
- "  여러   공백   테스트  " → "여러 공백 테스트"

### 3. 후처리 테스트
- 과거 날짜 생성 → 내일로 자동 조정
- 제목 50자 초과 → "제목제목제목..." (47자 + ...)
- 필수 필드 누락 → 기본값 설정

## 성공 확인

✅ 모든 검증 규칙이 정상 작동
✅ 전처리로 입력 정규화 성공
✅ 후처리로 데이터 안정성 확보
✅ 사용자 친화적 오류 메시지 제공

## 참고 문서
- 개발일지: `개발일지/20260111_AI입력검증개선.md`
- API Route: `app/api/generate-todo/route.ts`
